<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapitre 1 Construire un package  | Formation  avancée</title>
<meta name="author" content="Robin Genuer 🌐 &amp; Boris Hejblum 🌐">
<meta name="description" content="Nous présentons ici comment construire un package efficacement à l’aide d’outils graphiques présents dans RStudio et du package devtools. Le support de référence sur ce sujet est le livre R...">
<meta name="generator" content="bookdown 0.35 with bs4_book()">
<meta property="og:title" content="Chapitre 1 Construire un package  | Formation  avancée">
<meta property="og:type" content="book">
<meta property="og:description" content="Nous présentons ici comment construire un package efficacement à l’aide d’outils graphiques présents dans RStudio et du package devtools. Le support de référence sur ce sujet est le livre R...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapitre 1 Construire un package  | Formation  avancée">
<meta name="twitter:description" content="Nous présentons ici comment construire un package efficacement à l’aide d’outils graphiques présents dans RStudio et du package devtools. Le support de référence sur ce sujet est le livre R...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.5.1/transition.js"></script><script src="libs/bs3compat-0.5.1/tabs.js"></script><script src="libs/bs3compat-0.5.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.6.2/htmlwidgets.js"></script><script src="libs/d3-3.5.6/d3.min.js"></script><link href="libs/profvis-0.3.6.9000/profvis.css" rel="stylesheet">
<script src="libs/profvis-0.3.6.9000/profvis.js"></script><script src="libs/profvis-0.3.6.9000/scroll.js"></script><link href="libs/highlight-6.2.0/textmate.css" rel="stylesheet">
<script src="libs/highlight-6.2.0/highlight.js"></script><script src="libs/profvis-binding-0.3.8/profvis.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="&lt;em&gt;Outils de développement et de performance&lt;/em&gt;">Formation <svg aria-hidden="true" role="img" viewbox="0 0 581 512" style="height:1em;width:1.13em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z"></path></svg> avancée</a>:
        <small class="text-muted"><em>Outils de développement et de performance</em></small>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Présentation de la formation</a></li>
<li><a class="active" href="construire-un-package.html"><span class="header-section-number">1</span> Construire un package </a></li>
<li><a class="" href="contr%C3%B4le-de-version-avec-git-et-github-historique-de-changement-d%C3%A9veloppement-collaboratif-et-int%C3%A9gration-continue.html"><span class="header-section-number">2</span> Contrôle de version avec git et GitHub: historique de changement, développement collaboratif et intégration continue</a></li>
<li><a class="" href="mesurer-et-comparer-des-temps-dex%C3%A9cution.html"><span class="header-section-number">3</span> Mesurer et comparer des temps d’exécution</a></li>
<li><a class="" href="profiler-son-code.html"><span class="header-section-number">4</span> Profiler son code</a></li>
<li><a class="" href="rcpp-ou-comment-int%C3%A9grer-facilement-du-code-cdans-un-package.html"><span class="header-section-number">5</span> Rcpp ou comment intégrer facilement du code C++dans un package </a></li>
<li><a class="" href="parall%C3%A9lisation-du-code-r.html"><span class="header-section-number">6</span> Parallélisation du code R</a></li>
<li><a class="" href="take-home-message.html"><span class="header-section-number">7</span> Take Home message</a></li>
<li><a class="" href="r%C3%A9f%C3%A9rences.html">Références</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="construire-un-package" class="section level1" number="1">
<h1>
<span class="header-section-number">Chapitre 1</span> Construire un package <svg aria-hidden="true" role="img" viewbox="0 0 581 512" style="height:1em;width:1.13em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z"></path></svg><a class="anchor" aria-label="anchor" href="#construire-un-package"><i class="fas fa-link"></i></a>
</h1>
<p>Nous présentons ici comment construire un package efficacement à l’aide d’outils
graphiques présents dans <code>RStudio</code> et du package <code>devtools</code>.</p>
<p>Le support de référence sur ce sujet est le livre
<a href="https://r-pkgs.org/"><em>R packages</em></a><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;em&gt;R Packages&lt;/em&gt; (2&lt;sup&gt;nd&lt;/sup&gt; Edition) by Hadley Wickham, Jennifer Bryan. O’Reilly, 2023. ISBN: 9781098134945. &lt;a href="https://r-pkgs.org/"&gt;https://r-pkgs.org/&lt;/a&gt;&lt;/p&gt;'><sup>1</sup></a> d’Hadley Wickham &amp; Jennifer Bryan, disponible en ligne.</p>
<div id="initialiser-un-package" class="section level2" number="1.1">
<h2>
<span class="header-section-number">1.1</span> Initialiser un package<a class="anchor" aria-label="anchor" href="#initialiser-un-package"><i class="fas fa-link"></i></a>
</h2>
<p>Une manière simple, et intégrée à <code>RStudio</code>, pour <strong>initialiser un package</strong> est d’executer les étapes suivantes :</p>
<blockquote>
<p>👉 <strong>À vous de jouer</strong> (déjà)!</p>
<ol style="list-style-type: decimal">
<li><p>créer un nouveau projet (menu déroulant en haut à gauche dans <em>RStudio</em>)</p></li>
<li><p>choisir “<em>New Directory</em>”</p></li>
<li><p>choisir “<em>R package using devtools</em>” (s’il n’est pas disponible c’est que le package <code>devtools</code> n’est pas installer et dans ce cas on peut alors choisir “<em>R package</em>” – la différence étant qu’avec “<em>R package</em>”, il faudra supprimer des fichiers créés automatiquement mais inutiles)</p></li>
<li><p>donner un nom au package, par exemple <code>mypkgr</code>.</p></li>
</ol>
</blockquote>
<p>On récupère alors la structure <strong>minimale pour un package <svg aria-hidden="true" role="img" viewbox="0 0 581 512" style="height:1em;width:1.13em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z"></path></svg></strong>, à savoir :</p>
<ul>
<li><p>un fichier <strong>DESCRIPTION</strong> dont les parties <code>Title</code>, <code>Version</code>, <code>Authors@R</code> et
<code>Description</code> sont à éditer (d’autres parties pourront être éditer voire
même ajouter de manière automatique, comme nous le verrons plus loin)</p></li>
<li><p>un fichier <strong>NAMESPACE</strong> qui sera édité automatiquement ultérieurement</p></li>
<li><p>un dossier <strong>R/</strong> dans lequel on va ajouter des fichiers de scripts <code>.R</code></p></li>
</ul>
<p><code>devtools</code> ajoute également trois <strong>fichiers <em>facultatifs</em></strong> :</p>
<ul>
<li><p><strong>.gitignore</strong>, relatif à <code>git</code>, outils de contrôle de version que nous verrons en détails dans la partie suivante sur <code>git</code> &amp; <em>GitHub</em></p></li>
<li><p><strong>mypkgr.Rproj</strong> qui est un fichier spécifique de <em>RStudio</em>, et permet de définirles caractéristiques et préférences du projet que nous venons de créer</p></li>
<li><p><strong>.Rbuildignore</strong> qui permet d’ignorer certains fichiers au moment où on construira le package un peu plus loin (par exemple, le fichier <code>mypkgr.Rproj</code> ne doit pas être inclus dans le package)</p></li>
</ul>
</div>
<div id="ajouter-une-fonction-exemple-fil-rouge" class="section level2" number="1.2">
<h2>
<span class="header-section-number">1.2</span> Ajouter une fonction : exemple fil rouge<a class="anchor" aria-label="anchor" href="#ajouter-une-fonction-exemple-fil-rouge"><i class="fas fa-link"></i></a>
</h2>
<p>Nous vous proposons de coder la fonction suivante, que nous reprendrons tout au
long de la formation :</p>
<p>Nous souhaitons calculer la valeur de la densité d’une loi normale multivariée
sur <span class="math inline">\(\mathbb{R}^p\)</span> en <span class="math inline">\(n\)</span> points. Notre fonction doit pouvoir s’appliquer pour
n’importe quelle loi normale multivariée (vecteur de moyennes <span class="math inline">\(\boldsymbol \mu\)</span> dans
<span class="math inline">\(\mathbb{R}^p\)</span> et matrice de variance-covariance <span class="math inline">\(\boldsymbol\Sigma\)</span> d’ordre de <span class="math inline">\(p\)</span> quelconques),
et on souhaite pouvoir calculer toutes les valeurs de la densité évaluées
sur les <span class="math inline">\(n\)</span> points <span class="math inline">\(\mathbf{x}\)</span> en un seul appel de la fonction.</p>
<p>Pour rappel, la fonction de densité d’une loi normale multivariée s’écrit :
<span class="math display">\[\displaystyle (2\pi )^{-p/2}\det({\boldsymbol {\Sigma }})^{-1/2}\,\exp \left(-{\frac {1}{2}}(\mathbf {x} -{\boldsymbol {\mu }})^{\mathsf {T}}{\boldsymbol {\Sigma }}^{-1}(\mathbf {x} -{\boldsymbol {\mu }})\right)\]</span></p>
<p>Vous devez donc créer une fonction <code>mvnpdf()</code> dans un fichier nommé <code>mvnpdf.R</code>
dans le dossier <code>R/</code> du package, qui :</p>
<ul>
<li>
<p>prend en arguments :</p>
<ul>
<li><p><code>x</code> une matrice, à <span class="math inline">\(n\)</span> colonnes (les observations) et <span class="math inline">\(p\)</span> lignes</p></li>
<li><p><code>mean</code> un vecteur de moyennes</p></li>
<li><p><code>varcovM</code> une matrice de variance-covariance</p></li>
<li><p><code>Log</code> un paramètre logique valant <code>TRUE</code> par défaut</p></li>
</ul>
</li>
<li><p>renvoie une liste contenant la matrice <code>x</code> ainsi qu’un vecteur des images
des points de <code>x</code> par la fonction de densité de la variable aléatoire de loi
normale multivariée considérée.</p></li>
</ul>
<blockquote>
<p><strong><em>👉 À vous de jouer !</em></strong></p>
</blockquote>
<p>Voici une proposition de fonction que vous pouvez télécharger
<a href="https://r-dev-perf.borishejblum.science/FormationRavancee_dev_perf_files/mvnpdfRAW.R">ici</a>. ⚠️ <em>ATTENTION !</em> Si vous cliquez trop vite sur le lien ci-dessous, cela invalidera votre participation à la formation !</p>
<p>Pour des conseils lors de la rédaction de code, voir le chapitre
<a href="https://r-pkgs.org/code.html">R code</a> dans <em>R packages</em> (2023) de Wickham &amp; Bryan<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;em&gt;R Packages&lt;/em&gt; (2&lt;sup&gt;nd&lt;/sup&gt; Edition) by Hadley Wickham, Jennifer Bryan. O’Reilly, 2023. ISBN: 9781098134945. &lt;a href="https://r-pkgs.org/"&gt;https://r-pkgs.org/&lt;/a&gt;&lt;/p&gt;'><sup>2</sup></a>.</p>
</div>
<div id="documenter-une-fonction" class="section level2" number="1.3">
<h2>
<span class="header-section-number">1.3</span> Documenter une fonction<a class="anchor" aria-label="anchor" href="#documenter-une-fonction"><i class="fas fa-link"></i></a>
</h2>
<p>Il est important de bien documenter votre code. Tout projet a au moins 2
développeurs :</p>
<ul>
<li><p>vous</p></li>
<li><p>vous dans 6 mois</p></li>
</ul>
<p>Par égard à votre <em>“futur vous”</em>, soyez sympas et prenez le temps de documenter
votre code 😉 !</p>
<p>Nous vous conseillons vivement d’utiliser le package <code>roxygen2</code> pour documenter
vos packages. L’avantage principal étant d’avoir l’aide d’une fonction dans
le même fichier que le code définissant cette fonction.</p>
<blockquote>
<p><strong><em>👉 À vous de jouer !</em></strong></p>
<ol style="list-style-type: decimal">
<li><p>Commencer par insérer le squelette de l’aide grâce à “Insert Roxygen
Skeleton” situé dans le menu “Code” ou le sous-menu <em>Baguette magique</em> dans
la fenêtre de script.</p></li>
<li>
<p>Compléter la documentation en renseignant :</p>
<ul>
<li><p>le titre de la fonction (première ligne)</p></li>
<li><p>la description de ce que fait la fonction (deuxième paragraphe)</p></li>
<li><p>si vous renseignez un troisième paragraphe, cette partie ira dans la section “Details” de la page d’aide</p></li>
<li><p>la signification des paramètres</p></li>
<li><p>la sortie, après la balise <code>@return</code></p></li>
</ul>
</li>
<li>
<p>Générer la documentation à l’aide de “Document” dans le menu “More” de l’onglet “Build” (ou Ctrl+Shift+D ou <code><a href="https://devtools.r-lib.org/reference/document.html">devtools::document()</a></code>). L’effet de cette commande est multiple :</p>
<ul>
<li><p>un dossier <code>man</code> a été créé et à l’intérieur, un fichier <code>mvnpdf.Rd</code> a été créé et contient les informations de l’aide de la fonction</p></li>
<li><p>le fichier <code>NAMESPACE</code> a été modifié</p></li>
</ul>
</li>
</ol>
</blockquote>
<p><strong>En cas de bug ou par curiosité ET une fois que vous avez terminé</strong> vous pouvez consulter cette <a href="https://r-dev-perf.borishejblum.science/FormationRavancee_dev_perf_files/mvnpdfRox.R">proposition</a>.</p>
<p>Pour plus de détails sur la documentation de package et les balises
<code>roxygen2</code>, voir la page
<a href="https://r-pkgs.org/man.html">Object documentation</a> du site d’Hadley.</p>
<p>Finissons par évoquer une fonction du package <code>usethis</code> qui initialise une
page d’aide pour le package dans son ensemble :</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_package_doc.html">use_package_doc</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>La page d’aide générée sera alors accessible, une fois le package installé,
via :</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">?</span><span class="va">mypkgr</span></span></code></pre></div>
</div>
<div id="tester-le-package-de-manière-intéractive" class="section level2" number="1.4">
<h2>
<span class="header-section-number">1.4</span> Tester le package de manière <em>intéractive</em><a class="anchor" aria-label="anchor" href="#tester-le-package-de-mani%C3%A8re-int%C3%A9ractive"><i class="fas fa-link"></i></a>
</h2>
<p>Pour tester le package, vous devez le charger dans R à l’aide de :
dans l’onglet “Build”, le menu “More” puis “Load All” (ou Ctrl+Shift+L ou
<code><a href="https://devtools.r-lib.org/reference/load_all.html">devtools::load_all()</a></code>).</p>
<p>Vous pouvez alors utiliser votre package directement dans R : consulter
l’aide de la fonction avec <code>?mvnpdf</code> et par exemple exécuter les commandes renseignées dans la section exemple de cette page d’aide.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">?</span><span class="va">mvndpf</span></span></code></pre></div>
<p>Ainsi, lors du développement, vous pouvez :</p>
<ul>
<li><p>Ajouter/Modifier le code <svg aria-hidden="true" role="img" viewbox="0 0 581 512" style="height:1em;width:1.13em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z"></path></svg></p></li>
<li><p>Re-charger le package <code>Ctrl+Shift+L</code></p></li>
<li><p>L’essayer dans la console</p></li>
<li><p>Et ainsi de suite…</p></li>
</ul>
</div>
<div id="tester-le-package-de-manière-automatique" class="section level2" number="1.5">
<h2>
<span class="header-section-number">1.5</span> Tester le package de manière <em>automatique</em><a class="anchor" aria-label="anchor" href="#tester-le-package-de-mani%C3%A8re-automatique"><i class="fas fa-link"></i></a>
</h2>
<p>Pour initialiser la fonctionnalité de tests automatiques dans le package, executer la commande suivante :</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_testthat.html">use_testthat</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Cette commande induit la création d’un dossier <code>tests</code> qui comprend un fichier <code>testthat.R</code> – à ne pas modifier – et un dossier <code>testthat/</code> dans lequel on va insérer nos tests. Cet outils s’appuie sur la théorie des <em>tests unitaires</em>.</p>
<p>Voici par exemple le contenu d’un fichier contenant 2 tests qui devrait s’appeller <code>test-mvnpdf.R</code> à mettre dans le dossier <code>testthat/</code> (plutôt que de le créer vous-même, vous pouvez simplement utiliser la fonction <code><a href="https://usethis.r-lib.org/reference/use_r.html">usethis::use_test()</a></code> qui créera le fichier pour vous en le plaçant directement au bon endroit) :</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"correct result for univariate gaussian"</span>, <span class="op">{</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="fu">mvnpdf</span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">1.96</span><span class="op">)</span>, Log<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">y</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">1.96</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="fu">mvnpdf</span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.96</span>, <span class="op">-</span><span class="fl">0.5</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, Log<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">y</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.96</span>, <span class="op">-</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"correct results for bivariate gaussian"</span>, <span class="op">{</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="fu">mvnpdf</span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1.96</span>,<span class="fl">2</span><span class="op">)</span>, nrow<span class="op">=</span><span class="fl">2</span>, ncol<span class="op">=</span><span class="fl">1</span><span class="op">)</span>, Log<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">y</span>,</span>
<span>               <span class="fu">mvtnorm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html">dmvnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1.96</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Pour exécuter ces tests, on peut utiliser “<em>Test package</em>” (<code>Ctrl+Shift+T</code>) du menu “<em>More</em>” dans l’onglet “<em>Build</em>”, ou alors executer <code><a href="https://devtools.r-lib.org/reference/test.html">devtools::test()</a></code> dans la console.</p>
<p>L’avantage de ces tests automatiques est qu’ils vont
s’exécuter à chaque fois qu’on effectuera un <em>check</em> du package.</p>
<p>Une bonne pratique est d’ajouter un test unitaire à chaque fois qu’un bug est identifié et résolu,
afin de pouvoir immédiatement identifier et prévenir qu’une erreur identique ne se reproduise dans
le futur.</p>
</div>
<div id="faire-un-check-du-package" class="section level2" number="1.6">
<h2>
<span class="header-section-number">1.6</span> Faire un <em>check</em> du package<a class="anchor" aria-label="anchor" href="#faire-un-check-du-package"><i class="fas fa-link"></i></a>
</h2>
<p>Faire un <em>check</em> signifie vérifier que tout est correct dans le package et fonctionne comme attendu, afin que l package puisse s’installer sans problème sur différents systèmes d’exploitation. Il est <strong>impératif</strong> de “passer” le <code>R CMD CHECK</code> pour pouvoir déposer un package sur le CRAN.</p>
<p>Pour exécuter celui-ci, utiliser “<em>Check</em>” (<code>Ctrl+Shift+E</code>) dans l’onglet “<em>Build</em>”, ou alors executez <code><a href="https://devtools.r-lib.org/reference/check.html">devtools::check()</a></code> dans la console.</p>
<p>Lors du <code>R CMD CHECK</code>, les tests que nous avons mis au point précédemment sont exécutées. C’est justement l’avantage d’avoir fait ces tests, nous n’avons plus besoin de s’en préoccuper, mais juste de réagir en cas d’erreurs renvoyées.</p>
</div>
<div id="installer-le-package" class="section level2" number="1.7">
<h2>
<span class="header-section-number">1.7</span> Installer le package<a class="anchor" aria-label="anchor" href="#installer-le-package"><i class="fas fa-link"></i></a>
</h2>
<p>Pour le moment, le package n’existe que dans l’environnement associé au projet Rstudio qu’on a créé. Pour pouvoir l’utiliser dans R de manière générale, il faut l’installer (comme un package du CRAN par exemple).</p>
<p>Pour faire ça, utiliser “<em>Install and Restart</em>” <code>Ctrl+Shift+B</code> dans l’onglet “Build” (<code><a href="https://devtools.r-lib.org/reference/install.html">devtools::install()</a></code> ou ).</p>
<p>Et enfin, vous pouvez configurer le comportement de <em>RStudio</em> pour qu’au moment de l’installation, il documente en même temps le package : aller dans l’onglet “<em>Build</em>”, le menu “<em>More</em>” puis “<em>Configure Build Tools…</em>”. Cliquer ensuite sur “<em>Configure</em>” juste à côté de “<em>Generate documentation with Roxygen</em>” puis cocher la case “<em>Install and Restart</em>”.</p>
</div>
<div id="annexe-1.1-ajouter-une-méthode-s3" class="section level2 unnumbered">
<h2>Annexe 1.1 : ajouter une méthode S3<a class="anchor" aria-label="anchor" href="#annexe-1.1-ajouter-une-m%C3%A9thode-s3"><i class="fas fa-link"></i></a>
</h2>
<p>Dans la plupart des packages on est amenés à implémenter des méthodes S3,
très souvent pour qu’à partir d’un objet résultat <code>res</code>, on puisse exécuter
<code>print(res)</code>, <code>summary(res)</code>, <code>plot(res)</code>…</p>
<p>Voici un exemple de méthode <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> qu’on peut ajouter dans notre package :</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Plot of the mvnpdf function</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param x an object of class \code{mvnpdf} resulting from a call of</span></span>
<span><span class="co">#' \code{mnvpdf()} function.</span></span>
<span><span class="co">#' @param ... graphical parameters passed to \code{plot()} function.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return Nothing is returned, only a plot is given.</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' pdfvalues &lt;- mvnpdf(x=matrix(seq(-3, 3, by = 0.1), nrow = 1), Log=FALSE)</span></span>
<span><span class="co">#' plot(pdfvalues)</span></span>
<span><span class="va">plot.mvnpdf</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">x</span>, <span class="va">x</span><span class="op">$</span><span class="va">y</span>, type <span class="op">=</span> <span class="st">"l"</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>⚠️ <em>ATTENTION !</em> Pour que cette méthode fasse bien ce qu’on veut quand on
l’applique au résultat de notre fonction <code>mvnpdf()</code>, il faut déclarer que
ce résultat est de classe <code>mvnpdf</code>.</p>
<p>Tester cette fonction, en exécutant l’exemple.<br><em>N’oubliez pas de réinstaller le package (“Install and Restart” ou Ctrl+Shift+B).</em></p>
<p>Consulter le contenu du dossier <code>man</code> et les modifications qui ont été
apportées au fichier <code>NAMESPACE</code>.</p>
<p><em>Voici une proposition de solution</em> : le
<a href="https://r-dev-perf.borishejblum.science/FormationRavancee_dev_perf_files/mvnpdf.R">fichier</a>
contient le code complet
de la fonction <code>mvnpdf()</code> et de la méthode <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> associée.</p>
</div>
<div id="annexe-1.2-soumettre-son-package-au-cran" class="section level2 unnumbered">
<h2>Annexe 1.2 : soumettre son package au <a href="https://cran.r-project.org/web/packages/available_packages_by_name.html">CRAN</a><a class="anchor" aria-label="anchor" href="#annexe-1.2-soumettre-son-package-au-cran"><i class="fas fa-link"></i></a>
</h2>
<p>Executer les 2 commandes suivantes : <code><a href="https://devtools.r-lib.org/reference/check.html">devtools::check()</a></code> puis <code><a href="https://devtools.r-lib.org/reference/submit_cran.html">devtools::submit_cran()</a></code>.</p>
<p>Pour plus de détails, voir la <a href="https://r-pkgs.org/release.html#release-process">procédure recommandée</a> dans Wickham &amp; Bryan (2023)<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;em&gt;R Packages&lt;/em&gt; (2&lt;sup&gt;nd&lt;/sup&gt; Edition) by Hadley Wickham, Jennifer Bryan. O’Reilly, 2023. ISBN: 9781098134945. &lt;a href="https://r-pkgs.org/"&gt;https://r-pkgs.org/&lt;/a&gt;&lt;/p&gt;'><sup>3</sup></a></p>

</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="index.html">Présentation de la formation</a></div>
<div class="next"><a href="contr%C3%B4le-de-version-avec-git-et-github-historique-de-changement-d%C3%A9veloppement-collaboratif-et-int%C3%A9gration-continue.html"><span class="header-section-number">2</span> Contrôle de version avec git et GitHub: historique de changement, développement collaboratif et intégration continue</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#construire-un-package"><span class="header-section-number">1</span> Construire un package </a></li>
<li><a class="nav-link" href="#initialiser-un-package"><span class="header-section-number">1.1</span> Initialiser un package</a></li>
<li><a class="nav-link" href="#ajouter-une-fonction-exemple-fil-rouge"><span class="header-section-number">1.2</span> Ajouter une fonction : exemple fil rouge</a></li>
<li><a class="nav-link" href="#documenter-une-fonction"><span class="header-section-number">1.3</span> Documenter une fonction</a></li>
<li><a class="nav-link" href="#tester-le-package-de-mani%C3%A8re-int%C3%A9ractive"><span class="header-section-number">1.4</span> Tester le package de manière intéractive</a></li>
<li><a class="nav-link" href="#tester-le-package-de-mani%C3%A8re-automatique"><span class="header-section-number">1.5</span> Tester le package de manière automatique</a></li>
<li><a class="nav-link" href="#faire-un-check-du-package"><span class="header-section-number">1.6</span> Faire un check du package</a></li>
<li><a class="nav-link" href="#installer-le-package"><span class="header-section-number">1.7</span> Installer le package</a></li>
<li><a class="nav-link" href="#annexe-1.1-ajouter-une-m%C3%A9thode-s3">Annexe 1.1 : ajouter une méthode S3</a></li>
<li><a class="nav-link" href="#annexe-1.2-soumettre-son-package-au-cran">Annexe 1.2 : soumettre son package au CRAN</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Formation <svg aria-hidden="true" role="img" viewbox="0 0 581 512" style="height:1em;width:1.13em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z"></path></svg> avancée</strong>: <em>Outils de développement et de performance</em>" was written by <strong><em>Robin Genuer</em></strong> <a href="https://robin.genuer.fr/">🌐</a> &amp; <strong><em>Boris Hejblum</em></strong> <a href="https://borishejblum.science/">🌐</a>. It was last built on 2023-09-19.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
